import useBaseUrl from '@docusaurus/useBaseUrl';
import ThemedImage from '@theme/ThemedImage';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Laboratoire 17

# Mise en place d'une infrastructure VMware compl√®te

* * *

## Pr√©alables ‚úÖ
  - 3 h√¥tes ESXi
  - vCenter install√© et fonctionnel
  - Chaque noeud doit avoir:
    - Trois interfaces r√©seau
    - Deux disques suppl√©mentaires pour vSAN
      - 1 SSD (40 Go)
      - 1 HDD/SSD (250 Go)
  - Connexion √† un stockage r√©seau temporaire pour la phase initiale

:::important[Un mot sur les pr√©requis]
Une √©tape est r√©serv√©e √† la mise en place des pr√©requis dans le laboratoire. Vous pouvez donc partir de z√©ro si vous le voulez. Ce serait m√™me l'occasion de faire une bonne r√©vision.
:::

## Objectifs üéØ
  - Avoir un cluster VMware compos√© de 3 noeuds avec *vMotion*, haute-disponibilit√©, DRS et vSAN.


## √âtapes de r√©alisation üî¢

### 0. Mise en place des pr√©requis

Si vous d√©sirez partir de z√©ro, c'est ici qu'il faut commencer. Si vous avez d√©j√† une infrastructure, vous pouvez vous dirigez vers l'√©tape #1.

#### 0.1 Passerelle et Serveur DNS

Nous allons devoir se cr√©er une passerelle et un serveur DNS pour r√©pondre √† nos besoins. Pour la passerelle, vous pouvez utiliser le mod√®le `MODELE_pfSense (Sans DHCP)` disponible √† la racine du dossier Mod√®les dans LabInfo. Configurez une premi√®re carte sur `Acc√®s Internet` et l'autre sur l'un de vos r√©seaux priv√©s.

:::caution
Prenez note qu'en ce qui me concerne, j'utiliserai le r√©seau priv√© 192.168.21.0/24 pour mes d√©monstrations.
:::

Pour le serveur DNS, je vous laisse le soin de choisir le syst√®me d'exploitation de votre choix. N√©anmoins, assurez-vous de cr√©er une zone de recherche direct et une autre invers√©e dans lesquelles vous mettrez en place les enregistrements suivants:

**Zone de recherche direct:**
|Nom|Type|Destination|Description|
|---|----|-----------|-----------|
|@|NS|ns1.domaine.lan.|Enregistrement NS pour le serveur de noms|
|@|A|192.168.21.5|Enregistrement A au nom de la zone pointant vers l'IP de mon serveur DNS|
|ns1|A|192.168.21.5|Traduction du nom pour ns1|
|esx1|A|192.168.21.11|Enregistrement A pour ESXi-1|
|esx2|A|192.168.21.12|Enregistrement A pour ESXi-2|
|esx3|A|192.168.21.13|Enregistrement A pour ESXi-3|
|vcenter|A|192.168.21.21|Enregistrement A pour vCenter|

**Zone de recherche inverse:**
|Nom|Type|Destination|Description|
|---|----|-----------|-----------|
|@|NS|ns1.domaine.lan.|Enregistrement NS pour le serveur de noms|
|5|PTR|ns1.domaine.lan.|Enregistrement PTR pour ns1|
|11|PTR|esx1.domaine.lan|Enregistrement PTR pour ESXi-1|
|12|PTR|esx2.domaine.lan|Enregistrement PTR pour ESXi-2|
|13|PTR|esx3.domaine.lan|Enregistrement PTR pour ESXi-3|
|21|PTR|vcenter.domaine.lan|Enregistrement PTR pour vCenter|

#### 0.2 D√©ploiement des ESXi

J'ai cr√©√© un mod√®le d'hyperviseur ESXi pour vous permettre de gagner du temps. Vous pouvez assur√©ment l'utiliser, mais vous devrez l'adapter. Vous devrez donc suivre les √©tapes ci-dessous pour chaque hyperviseur √† cr√©er.

    - Dirigez-vous dans le dossier `Mod√®les` ‚Üí `420-5V6` et cloner le mod√®le **MODELE_ESXi_8.0.3_Golden** vers une machine virtuelle.
    - Personnaliser le mat√©riel de la machine virtuelle:
        - Ajustez la premi√®re carte r√©seau pour brancher celle-ci sur le r√©seau priv√© que d√©ssert votre passerelle.
        - Ajoutez une deuxi√®me interface r√©seau que vous relierez sur un autre de vos r√©seaux priv√©s.
        - Ajoutez une troisi√®me interface r√©seau que vous relierez sur un autre de vos r√©seaux priv√©s (Diff√©rent des interfaces pr√©c√©dentes).
        - Ajoutez un second disque dur de 40Go en vous assurant de le relier au contr√¥leur SATA.
        - Ajoutez un troisi√®me disque dur de 250Go en vous assurant de la relier au contr√¥leur SATA.
        - Supprimez le contr√¥leur SCSI qui aura √©t√© ajout√© automatiquement.
        - <mark>**Sur le noeud h√©bergeant vCenter seulement:**</mark>
            - Augmentez la m√©moire vive √† 24Go
        - Terminez.
    - D√©marrez la machine virtuelle que vous venez de d√©ployer.
    - Dans la console, ajustez les param√®tres IP et DNS conform√©ment √† ce que vous avez inscrit dans votre serveur DNS.

#### 0.3 D√©ploiement du client

J'ai cr√©√© un mod√®le de client que vous devez utiliser <span class="red-text">**obligatoirement**</span> si vous √™tes reparti de z√©ro. La raison est bien simple, vous devrez utiliser un script qui se trouve √† l'int√©rieur du mod√®le √† utiliser.

Dirigez-vous donc dans le dossier `Mod√®les` ‚Üí `420-5V6` et cloner le mod√®le **Client5V6_ScriptvCenter**. Ajustez sa carte r√©seau pour que celle-ci soit reli√©e au r√©seau interne que d√©ssert votre passerelle.

Suite au d√©marrage de votre client, configurez lui une adresse IP. Ensuite, d√©marrez un navigateur web au sein de votre client. Pour chaque noeud ESXi, r√©alisez les √©tapes suivantes:

- Ouvrez un navigateur web et tentez d'acc√©der √† l'h√¥te ESXi **<u>√† partir du nom de domaine.</u>**
- Ouvrez une session et confirmez que l'hyperviseur fonctionne bien.

#### 0.4 Configuration de vSwitch Standard pour iSCSI

Nous devons √† pr√©sent configurer un r√©seau pour notre stockage iSCSI. Dans le laboratoire pr√©c√©dent, nous avions utilis√© un *vSwitch* distribu√©. Or, pour utiliser un tel *vSwitch*, nous devons avoir acc√®s √† *vCenter*, que nous n'avons pas encore install√©. Pour faire changement, nous utiliserons des *vSwitch* standards cette fois.

Pour chaque serveur ESXi, suivez les √©tapes suivantes:

- Menu `Mise en r√©seau` ‚Üí `Commutateurs virtuels`
- Cliquez sur `Ajouter un commutateur virtuel standard`
    - Nom: vSwitch1
    - MTU: 9000
    - Liaison montante 1: vmnic1
- Ajouter