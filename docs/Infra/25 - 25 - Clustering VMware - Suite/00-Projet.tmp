import useBaseUrl from '@docusaurus/useBaseUrl';
import ThemedImage from '@theme/ThemedImage';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Projet final - Phase 2

Il est essentiel que vous ayez d√ªment compl√©t√© la Phase 1 du projet avant de vous lancer dans cette portion du projet. Prendre le risque de sauter certaines √©tapes pourrait vous obliger √† tout recommencer.

* * *

## Phase 2

Dans la phase 2, nous optimiseront l'infrastructure virtuelle et d√©ploieront certaines technologies en lien avec le *clustering*.

### 9. Migration vers vSwitch Distribu√©

Comme vous l'avez peut-√™tre d√©j√† remarqu√© dans la phase 1 de ce projet, nous n'utilisons que des *vSwitch Standards* pour le moment. En classe, nous avons vu que l'utilisation de *vSwitch Standards* n'est pas id√©al puisque celles-ci n√©cessitent:

- Une configuration s√©par√©e.
- Des r√©p√©titions dans le travail de gestion et d'administration. üòÆ‚Äçüí®
- Une attention particuli√®re pour √©viter les erreurs. üëÄ

Nous allons donc migrer notre configuration actuelle pour utiliser des *vSwitch Distribu√©s* qui nous permettent une meilleure efficacit√© et un risque d'erreur amoindri. Voici comment nous allons proc√©der. Voici l'architecture cible apr√®s les manipulations:


#### 9.10 Cr√©ation d'un premier vDS

Dans **vCenter**, s√©lectionnez votre *datacenter* puis cliquez sur `Nouveau Distributed Switch`:

- **Nom:** vDS Production
- **Version:** 8.0.3
- **Nombre de liaison montante:** 2
- **Network I/O Control:** Activ√©
- **Default PortGroup:** Aucun pour l'instant

#### 9.11 Cr√©ation d'un second VDS pour vMotion et vSAN

Dans **vCenter**, s√©lectionnez votre *datacenter* puis cliquez sur `Nouveau Distributed Switch`:

- **Nom:** vDS Services
- **Version:** 8.0.3
- **Nombre de liaison montante:** 2
- **Network I/O Control:** Activ√©
- **Default PortGroup:** Aucun pour l'instant

#### 9.20 Cr√©ation des groupes de ports pour vDS Production

Nous aurons besoin de deux groupes de ports distincts sur notre **vDS Production**: Un premier groupe pour l'administration et un second pour les *VMs*. Faites un clic √† l'aide du bouton de droite de la souris sur votre nouveau vDS et s√©lectionnez `Nouveau groupe de ports distribu√©s`:

- **Nom:** DPG-Management
- **Liaison de port:** Statique
- **Nombre de ports:** 8
- **Pool de ressources:** Aucun
- **VLAN:** Aucun
- **S√©curit√©:**
    - **Mode promiscuit√©:** Accepter
    - **Modifications de l'adresse MAC:** Accepter
    - **Transmissions forg√©es:** Accepter
- **Formation du traffic:** Par d√©faut
- **Association et basculement:** Par d√©faut
- **Surveillance:** Par d√©faut
- **Divers:** Par d√©faut

**<span class="red-text"><u>R√©p√©tez les m√™mes √©tapes pour vous cr√©er un groupe de ports nomm√© DPG-VM-Network sur le m√™me vDS</u></span>**

#### 9.21 Cr√©ation des groupes de ports pour vDS Services

Pour les groupes de ports du **vDS Services**, il faudra affecter des VLANs distincts puisque nous voulons effectuer une r√©elle s√©paration du traffic. Cr√©ez donc les groupes de ports comme vous l'avez effectu√© √† l'√©tape pr√©c√©dente, mais cette fois attribuez des VLANs (10 pour vSAN et 20 pour vMotion par exemple).

Assurez-vous de cr√©er les groupes de ports sur les bons commutateurs virtuels.

#### 9.3 Ajouter les h√¥tes aux vDS

Nous devons maintenant permettre aux hyperviseurs ESXi d'utiliser les vDS que nous venons de cr√©er. Pour cela, il faut ajouter des h√¥tes aux commutateurs virtuels. **Pour chacun des vDS, faites les √©tapes suivantes:**

- Clic √† l'aide du bouton de droite de la souris sur le vDS, puis `Ajoutez et g√©rez des h√¥tes`
- **S√©lectionner la t√¢che:** Ajouter des h√¥tes
- **S√©lectionner des h√¥tes:** Cocher tous les hyperviseurs
- **G√©rer les adapteurs physiques:** <span class="red-text">Ne rien cocher</span>
- **G√©rer les adapteurs VMKernel:** <span class="red-text">Ne rien cocher</span>
- **Migrer la mise en r√©seau des VMs:** <span class="red-text">Ne rien cocher</span>

#### 9.4 ‚ö†Ô∏è Migration de vmnic0 vers vDS ‚ö†Ô∏è

:::danger[Risque de perdre la connexion!]
Cette √©tape est √† la fois d√©licate et cruciale. Assurez-vous d'avoir du temps et de la concentration avant de proc√©der. Nous nous appr√™tons √† faire passer le r√©seau de gestion des hyperviseurs d'un **vSwitch Standard** √† un **vSwitch Distribu√©.** Vous perdrez donc la connexion avec vos hyperviseurs pendant un court instant. Une erreur de configuration √† cette √©tape vous obligera √† revenir en arri√®re. Respirez par le nez, dites *namast√©* et allez-y calmement üòä.
:::

**<span class="fonttaller">Pour les noeuds ne contenant <span class="red-text">PAS</span> vCenter:</span>**

Faites un clic √† l'aide du bouton de droite de la souris sur `vDS Production` et s√©lectionnez `Ajouter ou g√©rer des h√¥tes`:

- **S√©lectionnez la t√¢che:** G√©rez la mise en r√©seau de l'h√¥te
- **S√©lectionnez des h√¥tes:** Choisissez un seul noeud pour l'instant
- **G√©rer les adapteurs physiques:** Attribuez le vmnic0 √† l'uplink 1
- **G√©rer les adapteurs VMKernel:** Attribuez vmk0 √† votre groupe de ports `DPG-Management`
- **Migrer la mise en r√©seau VM:** Pas de modification ici
- **Prenez une grande respiration et cliquez sur `terminer`.**

<u>Refaites les m√™mes √©tapes pour l'autre noeud ne contenant PAS vCenter</u>

<br/><br/>
**<span class="fonttaller">Pour le noeud contenant vCenter:</span>**

Observez le sch√©ma ci-dessous. Remarquez comment, actuellement, notre machine vCenter d√©pend compl√®tement de notre *vSwitch0*. La probl√©matique que nous rencontreront est directement li√© √† cette d√©pendance ici. L'objectif est de remplacer notre *vSwitch0* (un vSS) par notre vDS-Prodction (un VDS). Or, vCenter poss√®de des protections contre les coupures de connexion. Si nous tentons de nous y prendre comme nous l'avons fait avec les deux autres noeuds, vCenter nous bloquera.

<div style={{textAlign: 'center'}}>
    <ThemedImage
        alt="Sch√©ma"
        sources={{
            light: useBaseUrl('/img/Virtu/ReplacevSwitch0_W.svg'),
            dark: useBaseUrl('/img/Virtu/ReplacevSwitch0_D.svg'),
        }}
    />
</div>

**Plan de match**


Suivez les √©tapes suivantes:

1. Branchez une vmnic suppl√©mentaire (branch√© derri√®re votre bridge) au vDS:
    - Dans vCenter, clic droit sur le vDS ‚Üí Ajoutez et G√©rer des h√¥tes...
    - **S√©lectionner la t√¢che:** G√©rer la mise en r√©seau de l'h√¥te
    - **S√©lectionner des h√¥tes:** L'h√¥te avec vCenter
    - **G√©rer les adapteurs physiques:** Assigner l'uplink 1 √† la vmnic2 (<mark>Ne touchez pas vmnic0, laissez-le sur vSwitch0</mark>)
    - **G√©rer les adapteurs VMkernel:** Assigner vmk0 sur DPG-Management
    - **Migrer la mise en r√©seau des VMs:** Changez le r√©seau de vCenter vers DPG-Management
    - **Terminer**

2. 