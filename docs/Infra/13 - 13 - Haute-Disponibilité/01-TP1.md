# TP1 - 20%

* * *

# Date de remise : <span class="red-text">19 Octobre 2025 , 23h59</span>

* * *

## Contexte du TP

- **Environnement:** Cluster Proxmox avec **3 noeuds**
- **Sc√©nario:** Vous √™tes administrateur syst√®me d'une entreprise qui souhaite mettre en place une infrastructure virtualis√©e robuste avec haute disponibilit√©

:::caution
Afin que tout le monde puisse faire son propre TP, <u>**vous devez le faire sur LabInfo**</u>. Prenez note qu'il est possible de cloner des serveurs Proxmox dans LabInfo, mais il faut suivre une proc√©dure √† la lettre pour que cela fonctionne. Je vous donne cette proc√©dure un peu plus bas.
:::

## √âtapes de r√©alisation üî¢

### Cr√©er vos serveurs Proxmox

Pour compl√©ter le TP, vous aurez besoin respectivement de <span class="red-text">3 noeuds.</span> Chacun de ces noeuds doit poss√©der les caract√©ristiques suivantes:

- Processeur de 4 coeurs
- 16 Go de RAM
- 1 disque dur de 40Go (syst√®me)
- 2 disques durs de 250Go (stockage ZFS)
- 1 carte r√©seau branch√© sur `Acc√®s Internet N`

Installez Proxmox convenablement une premi√®re fois. <span class="yellow-text">Prenez soin de donner un nom d'h√¥te convenable! Ex: Node1</span>.

#### Cloner un serveur Proxmox

Pour cloner un serveur Proxmox, suivez les √©tapes suivantes:

1. Assurez-vous que le serveur source soit fonctionnel et **neuf!** (pas de *VM*, de conteneur ou de stockage de configur√©).
2. √âteignez le serveur source, puis proc√©dez au clonage dans LabInfo.
3. D√©marrez la machine nouv√®lement clon√©.
4. Lorsque le syst√®me aura d√©marr√©, forcez l'obtention d'une nouvelle IP via dhcp.

    ```bash
    dhclient #Relance le processus DHCP
    ```
5. Vous vous retrouverez temporairement avec deux adresses IP. Soit l'originale provenant du Proxmox originalement clon√© ainsi qu'une nouv√®lement obtenu. Il nous faut donc rel√¢cher les deux adresses, puis renouveler de nouveau.

    ![doubleIPs](../Assets/13/DoubleIPs.png)

    ```bash
    dhclient -r #Rel√¢chement des adresses
    ```
    ```bash
    dhclient #Renouv√®lement
    ```

    :::tip
    Pour une raison que j'ignore, Proxmox n'accepte pas de rel√¢cher l'adresse qui provient de la machine source avant d'obtenir une nouvelle adresse IP.
    :::

    **<span class="yellow-text">Notez bien l'adresse que vous avez obtenu!</span>**

6. √âditez le fichier `/etc/network/interfaces` et modifiez l'IP associ√©e au bridge

    ```yaml title='/etc/network/interfaces' showLineNumbers
    auto lo
    iface lo inet loopback

    iface ens192 inet manual

    auto vmbr0
    iface vmbr0 inet static
            address 172.30.8.214/16     # Cette adresse!!
            gateway 172.30.0.1          # La passerelle au besoin
            bridge-ports ens192
            bridge-stp off
            bridge-fd 0
            
    source /etc/network/interfaces.d/*
    ```
7. √âditez le fichier `/etc/hosts` et modifiez l'ip et le nom d'h√¥te

    ```yaml title='/etc/hosts' showLineNumbers
    127.0.0.1 localhost.localdomain localhost
    172.30.8.214 node02.gabriel.local node02  # Modifiez cette ligne

    # The following lines are desirable for IPv6 capable hosts

    ::1     ip6-localhost ip6-loopback
    fe00::0 ip6-localnet
    ff00::0 ip6-mcastprefix
    ff02::1 ip6-allnodes
    ff02::2 ip6-allrouters
    ff02::3 ip6-allhosts
    ```

8. Supprimez le contenu du dossier `/etc/pve/nodes/template`

    ```bash
    rm -rf /etc/pve/nodes/template
    ```

9. Supprimez le fichier `/etc/machine-id`

    ```bash
    rm -f /etc/machine-id
    ```

10. Supprimez le fichier `/var/lib/dbus/machine-id`

    ```bash
    rm -f /var/lib/dbus/machine-id
    ```

11. G√©n√©rez un nouvel identifiant unique pour le noeud

    ```bash
    dbus-uuidgen --ensure=/etc/machine-id
    ```

12. D√©finissez le nouveau nom de la machine

    ```bash
    hostnamectl set-hostname Node02
    ```

13. Voil√†! Red√©marrez le nouveau noeud et il sera pr√™t √† √™tre utilis√©.

### √âtape 1 : **ZFS** (10 points)

Sur chacun des noeuds:

- Cr√©er un pool **ZFS** (*2 points*)
- Cr√©er les datasets suivants: (*8 points*)

    |Nom|Type|Contenu|
    |---|----|-------|
    |`vm-prod`|ZFS|Disques durs des *VMs* de la production|
    |`vm-dev`|ZFS|Disques durs des *VMs* des d√©veloppeurs|
    |`backups`|Directory|Fichiers de sauvegarde|
    |`templates`|ZFS|Disques durs des *VMs* mod√®les(*templates*)|

**<span class="fonttaller green-text">Livrables pour cette √©tape:</span>**

- Sortie de `zpool list` montrant le pool ZFS cr√©√© dans chaque noeud.
- Sortie de `zfs list` montrant les datasets cr√©√©s dans chaque noeud.
- Captures d'√©cran de la configuration des storages dans Proxmox.

### √âtape 2 : **Utilisateurs et permissions** (15 points)

Cr√©er les groupes suivants: (3 points)

- `admins-infra`: Administrateurs complets
- `ops-backup`: √âquipe responsable des sauvegardes
- `devs-junior`: D√©veloppeurs avec acc√®s limit√©

Cr√©er les utilisateurs suivants dans le realm PVE: (4 points)

- `admin1@pve` (membre de `admins-infra`)
- `backup-ops@pve` (membre de `ops-backup`)
- `dev1@pve` (membre de `devs-junior`)

Configurer les permissions suivantes: (8 points)

- Le groupe `admins-infra` doit avoir tous les droits sur `/`
- Le groupe `ops-backup` doit pouvoir:
    - Voir toutes les *VMs*
    - G√©rer les sauvegardes (cr√©ation, restauration, suppression)
    - Acc√©der au stockage de backup uniquement
- Le groupe `devs-junior` doit pouvoir, sur le pool `dev-pool` uniquement :
    - D√©marrer/arr√™ter les *VMs*
    - Acc√©der √† la console (l'√©cran des *vms*)
    - **NE PAS** pouvoir supprimer ou cr√©er des *VMs*

**<span class="fonttaller green-text">Livrables pour cette √©tape:</span>**

- Captures d'√©cran de la configuration des permissions.
- Captures d'√©cran des diff√©rents tests d√©montrant un acc√®s ou une interdiction.

### √âtape 3: **Gestion des VMs et des Pools** (20 points)

Cr√©er les pools de ressources suivants (3 points):

- `prod-pool`: *VMs* de production
- `dev-pool`: *VMs* de d√©veloppement
- `backup-pool`: *VMs* de test de restauration

Cr√©er et configurer les *VMs* suivantes (12 points):

|**VM**|**Pool**|**OS**|**vCPU**|**RAM**|**Disque**|**Stockage ZFS**|**Particularit√©s**|
|------|--------|------|--------|-------|----------|----------------|------------------|
|web-prod-01|prod-pool|Ubuntu/Debian|2|2GB|20GB|vm-prod|- Doit √™tre HA<br/>- 2 interfaces r√©seaux (2 *bridges* distincts)<br />- D√©marrage automatique|
|db-prod-01|prod-pool|Ubuntu/Debian|4|4GB|40GB|vm-prod|- Doit √™tre HA<br/>- D√©marrage automatique avec d√©lai de 30 secondes|
|dev-test-01|dev-pool|Alpine/Debian|1|1GB|10GB|vm-dev|- Non-HA|

Cr√©er √©galement un *template* √† partir d'une *VM* de base (au choix) nomm√© `template-base-debian` sur le dataset `templates`

**<span class="fonttaller green-text">Livrables pour cette √©tape:</span>**

- Captures d'√©cran de chaque *VM* avec sa configuration
- Sortie de la configuration d'une *VM* ( `qm config <vmid>` )
- Liste des pools avec leurs *VMs* assign√©es
- V√©rification du dataset ZFS utilis√© pour chaque *VM* ( `zfs list -t all | grep <vmid>` )

### √âtape 4: **Sauvegardes et r√©tention** (25 points)

Cr√©er les t√¢ches de sauvegarde suivantes (15 points):

**<span class="fonttaller">T√¢che 1</span>**

- Nom: `backup-prod-daily`
- Cible: Toutes les *VMs* du pool `prod-pool`
- Destination: Stockage `backups` (dataset ZFS)
- Mode: Snapshot
- Compression: ZSTD
- Planification: Tous les jours √† 2h00
- R√©tention:
    - Conserver les 7 derniers backups quotidiens
    - Conserver les 4 derniers backups hebdomadaires
    - Conserver les 3 derniers backups mensuels

**<span class="fonttaller">T√¢che 2</span>**

- Nom: `backup-dev-weekly`
- Cible: Toutes les *VMs* du pool `dev-pool`
- Destination: Stockage `backups` (dataset ZFS)
- Mode: Stop
- Compression: LZO (rapide)
- Planification: Tous les dimanches √† 4h00
- R√©tention: Conserver uniquement les deux derniers backups

Tests de sauvegarde et de restauration (10 points):

- Lancer manuellement un backup de `web-prod-01`
- Restaurer ce backup en tant que nouvelle *VM* nomm√©e `web-prod-01-restore` dans le pool `backup-pool`
- V√©rifiez l'int√©grit√© de la *VM* restaur√©e (d√©marrage,configuration r√©seau)
- Observer l'impact de la compression ZFS sur la taille des backups

**<span class="fonttaller green-text">Livrables pour cette √©tape:</span>**

- Captures d'√©cran de la configuration de chaque job de backup
- Liste des backups disponibles pour chaque VM
- Documentation du processus de restauration avec captures d'√©cran
- Analyse de l'espace disque utilis√© par les backups (avant/apr√®s compression)

### √âtape 5: **R√©plication et Migration** (10 points)

Migration de *VMs* (5 points):

- Effectuer une migration √† chaud (*online*) de `web-prod-01` vers un autre noeud.
- Effectuer une migration √† froid (*offline*) de `dev-test-01` vers un autre noeud.
- Documenter les diff√©rences entre les deux m√©thodes et les conditions requises.

R√©plication ZFS (5 points):

- Configurer une t√¢che de r√©plication ZFS pour `db-prod-01` vers un autre n≈ìud
- Planification : Toutes les 15 minutes
- Lancer manuellement une r√©plication et v√©rifier qu'elle fonctionne
- V√©rifier la pr√©sence du snapshot de r√©plication sur le n≈ìud cible avec zfs list -t snapshot
- Expliquer la diff√©rence entre la r√©plication et la sauvegarde

**<span class="fonttaller green-text">Livrables pour cette √©tape:</span>**

- Sortie de la commande `pvecm status`
- Captures d'√©cran des migrations en cours
- Configuration de la r√©plication avec logs de succ√®s
- Sortie de `zfs list -t snapshot` sur les noeuds source et cible
- Documentation comparative: migration vs r√©plication vs backup

### √âtape 6: **Haute-Disponibilit√©** (20 points)

Configuration HA (8 points):

- Activer la haute disponibilit√© pour `web-prod-01` et `db-prod-01`
- Configurer les groupes HA avec les priorit√©s suivantes:
    - `web-prod-01`: priorit√© 100
    - `db-prod-01`: priorit√© 200 (plus critique)
- D√©finir la politique de red√©marrage: max 3 tentatives
- V√©rifier que la r√©plication ZFS est active pour les *VMs* HA

Test de basculement (8 points):

- **Test1**: Arr√™ter brutalement une *VM* HA et observez son comportement
- **Test2**: Simuler une panne de noeud
    - Documenter le temps de d√©tection et de red√©marrage
    - V√©rifiez les logs HA (`/var/log/pve-ha-lrm.log` et `/var/log/pve-ha-crm.log`)
    - Observez comment HA utilise la r√©plication ZFS pour red√©marrer la ou les *VMs*

Analyse et optimisation (4 points):

- Expliquer les pr√©requis pour que HA fonctionne (quorum, r√©plication ZFS, etc.)
- Documenter les limitations observ√©es
- Proposer un sc√©nario o√π HA ne fonctionnerait PAS et expliquer pourquoi
- Analyser l'importance de la r√©plication ZFS dans le m√©canisme de HA

**<span class="fonttaller green-text">Livrables pour cette √©tape:</span>**

- Configuration HA avec captures d'√©cran
- Logs des tests de basculement avec timestamps
- S√©quence de captures montrant le basculement automatique
- Rapport d'analyse des pr√©requis et limitations

## Format du livrable final üìñ

Un document Word structur√© contenant:

1. Page de pr√©sentation (nom, date, cours, etc.)
2. Table des mati√®res
3. Pour chaque partie:
    - Captures d'√©cran annot√©es
    - Commandes utilis√©es (notamment les commandes ZFS)
    - Explications
    - R√©sultats des tests au besoin
4. Conclusion personnelle sur vos apprentissages et les d√©fis rencontr√©s.

## Grille d'√©valuation ‚úÖ

|Crit√®re|Points|D√©tails|
|-------|:------:|--------|
|**<span class="green-text">Partie 1</span>**||<span class="green-text">ZFS</span>|
|Cr√©ation du pool|2|-Commande `zpool list` (**1 pt**)<br/>-Documentation claire (captures d'√©cran et explications) (**1 pt**)|
|Cr√©ation des *datasets*|8|-Structure compl√®te avec les 4 *datasets* requis (**4 pts**)<br/>-Nomenclature coh√©rente et appropri√©e (**2 pts**)<br/>-Commandes ZFS utilis√©es justes (**2 pts**)|
|**<span class="green-text">Partie 2</span>**||<span class="green-text">Utilisateurs et permissions</span>|
|Cr√©ation des groupes|3|-3 groupes cr√©√©s avec les bons noms (**3 pts**)|
|Cr√©ation des utilisateurs|4|-3 utilisateurs dans le realm PVE (**3 pts**)<br/>-Assignation aux bons groupes (**1 pt**)|
|Permissions admins-infra|2|-Groupe a tous les droits sur `/` (**2 pts**)|
|Permissions ops-backup|3|-Droits de lecture sur toutes les *VMs* (**1 pt**)<br/>-Gestion compl√®te des backups (**1 pt**)<br/>-Restriction correcte au storage backup uniquement (**1 pt**)|
|Permissions devs-junior|2|-Droits limit√©s au pool dev-pool uniquement (**1 pt**)<br/>-Restrictions correctes: d√©marrage/console sans cr√©ation/suppression (**1 pt**)|
|Tests et validation|1|-Connexion test√©e et valid√©e avec chaque utilisateur (**1 pt**)|
|**<span class="green-text">Partie 3</span>**||<span class="green-text">VMs et Pools</span>|
|Cr√©ation des pools|3|-3 pools cr√©√©s (**2 pts**)<br/>-Organisation logique et pertinente (**1 pt**)|
|VM web-prod-01|3|-Configuration compl√®te selon les sp√©cifications (**2 pts**)<br/>-Sur le bon dataset ZFS (**1 pt**)|
|VM db-prod-01|3|-Configuration compl√®te selon les sp√©cifications (**2 pts**)<br/>-Sur le bon dataset ZFS (**1 pt**)|
|VM dev-test-01|3|-Configuration compl√®te selon les sp√©cifications (**2 pts**)<br/>-Sur le bon dataset ZFS (**1 pt**)|
|Double interface r√©seau|2|-Web-prod-01 avec 2 interfaces r√©seau configur√©es (**2 pts**)|
|D√©marrage automatique|2|-Les *VMs* de prod ont un d√©marrage automatique avec un d√©lai de 30 secondes entre les deux (**2 pts**)|
|Cr√©ation template|1|-template-base-debian cr√©√© sur *dataset* templates (**1 pt**)|
|Documentation|3|-Captures d'√©cran claires de chaque *VM* (**1 pt**)<br/>-Sortie de qm config fourni (**1 pt**)<br/>-V√©rification datasets ZFS (zfs list) (**1 pt**)|
|**<span class="green-text">Partie 4</span>**||<span class="green-text">Sauvegardes et r√©tention</span>|
|Configuration stockage backup|2|-*Dataset* backup configur√© (**1 pt**)<br/>-Espace disponible document√© (**1 pt**)|
|T√¢che backup-prod-daily|3|-Configuration compl√®te (pool,mode snapshot,ZSTD) (**1 pt**)<br/>-R√©tention correcte (7/4/3) (**1 pt**)<br/>-Planif quotidienne √† 2h00 (**1 pt**)|
|T√¢che backup-dev-weekly|2|-Configuration compl√®te (pool,mode stop,LZO) (**1 pt**)<br/>-R√©tention et planif hebdomadaire correctes (**1 pt**)|
|Test backup manuel|2|-Backup manuel de web-prod-01 r√©ussi (**1 pt**)<br/>-Documentation temps et taille du backup (**1 pt**)|
|Test de restauration|4|-Restauration en tant que web-prod-01-restore (**2 pts**)<br/>-VM fonctionnelle apr√®s restauration (**1 pt**)<br/>-Documentation du temps de restauration (**1 pt**)|
|Analyse compression ZFS|2|-Espace avant/apr√®s compression (**1 pt**)<br/>-Analyse de l'efficacit√© (**1 pt**)|
|**<span class="green-text">Partie 5</span>**||<span class="green-text">R√©plication et migration</span>|
|V√©rification du cluster|1|-Sortie de la commande pvecm status (**1 pt**)|
|Migration Online|2|-Migration √† chaud de web-prod-01 r√©ussie (**1 pt**)<br/>-Documentation avec captures et diff√©rences (**1 pt**)|
|Migration Offline|2|-Migration √† froid de dev-test-01 r√©ussie (**1 pt**)<br/>-Documentation avec captures et diff√©rences (**1 pt**)|
|R√©plication ZFS|5|-Configuration de r√©plication pour db-prod-01 (**2 pts**)<br/>-Test manuel r√©ussi avec v√©rification snapshots (zfs list) (**1 pt**)<br/>-Explication diff√©rence entre r√©plication et sauvegarde (**2 pts**)|
|**<span class="green-text">Partie 6</span>**||<span class="green-text">Haute-Disponibilit√©</span>|
|Configuration HA|6|-Activation HA sur web-prod-01 et db-prod-01 (**2 pts**)<br/>-Priorit√©s configur√©es correctement (100 et 200) (**2 pts**)<br/>-Politique red√©marrage 3 tentatives (**1 pt**)<br/>-V√©rification r√©plication ZFS active (**1 pt**)|
|Test 1: Arr√™t VM|4|-Test d'arr√™t brutal effectu√© (**2 pts**)<br/>-Documentation comportement et red√©marrage auto (**2 pts**)|
|Test 2: Panne de noeud|5|-Test panne noeud effectu√© (**2 pts**)<br/>-Temps de d√©tection document√© (**1 pt**)<br/>-Logs HA analys√©s (**2 pts**)|
|Analyse HA|5|-Pr√©requis HA clairement expliqu√©s (quorum, r√©plication) (**2 pts**)<br/>-Limitations observ√©es identifi√©es (**1 pt**)<br/>-Sc√©nario d'√©chec pertinent avec explication (**2 pts**)|
|**<span class="green-text">Partie 7</span>**||<span class="green-text">Pr√©sentation du document</span>|
|Structure et organisation|3|-Page de pr√©sentation (**1 pt**)<br/>-Table des mati√®res d√©taill√©e et compl√®te (**1 pt**)<br/>-Sections bien organis√©es et logiques (**1 pt**)|
|Qualit√© des captures d'√©cran|2|-Captures pertinentes, lisibles et de bonne qualit√© (**1 pt**)<br/>-Annotations claires (**1 pt**)|
|Clart√© des explications|2|-Explications techniques compr√©hensibles et pr√©cises (**2 pts**)|
|Professionnalisme g√©n√©ral|2|-Mise en forme soign√©e et coh√©rente (**1 pt**)<br/>-Orthographe et grammaire correcte (**1 pt**)|
|Conclusion personnelle|1|-R√©flexion pertinente sur les apprentissages r√©alis√©s et les d√©fis rencontr√©s (**1 pt**)|