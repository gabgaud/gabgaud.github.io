# TP1 - 20%

* * *

## Contexte du TP

- **Environnement:** Cluster Proxmox avec 3 noeuds
- **Sc√©nario:** Vous √™tes administrateur syst√®me d'une entreprise qui souhaite mettre en place une infrastructure virtualis√©e robuste avec haute disponibilit√©

:::caution
Afin que tout le monde puisse faire son propre TP, <u>**vous devez le faire sur LabInfo**</u>. Prenez note qu'il est possible de cloner des serveurs Proxmox dans LabInfo, mais il faut suivre une proc√©dure √† la lettre pour que cela fonctionne. Je vous donne cette proc√©dure un peu plus bas.
:::

## √âtapes de r√©alisation üî¢

### Cr√©er vos serveurs Proxmox

Pour compl√©ter le TP, vous aurez besoin respectivement de 3 noeuds. Chacun de ces noeuds doit poss√©der les caract√©ristiques suivantes:

- Processeur de 4 coeurs
- 16 Go de RAM
- 1 disque dur de 40Go (syst√®me)
- 2 disques durs de 250Go (stockage ZFS)
- 1 carte r√©seau branch√© sur `Acc√®s Internet N`

Installez Proxmox convenablement une premi√®re fois. <span class="yellow-text">Prenez soin de donner un nom d'h√¥te convenable! Ex: Node1</span>.

#### Cloner un serveur Proxmox

Pour cloner un serveur Proxmox, suivez les √©tapes suivantes:

1. Assurez-vous que le serveur source soit fonctionnel et **neuf!** (pas de *VM*, de conteneur ou de stockage de configur√©).
2. √âteignez le serveur source, puis proc√©dez au clonage dans LabInfo.
3. D√©marrez la machine nouv√®lement clon√©.
4. Lorsque le syst√®me aura d√©marr√©, forcez l'obtention d'une nouvelle IP via dhcp.

    ```bash
    dhclient #Relance le processus DHCP
    ```
5. Vous vous retrouverez temporairement avec deux adresses IP. Soit l'originale provenant du Proxmox originalement clon√© ainsi qu'une nouv√®lement obtenu. Il nous faut donc rel√¢cher les deux adresses, puis renouveler de nouveau.

    ![doubleIPs](../Assets/13/DoubleIPs.png)

    ```bash
    dhclient -r #Rel√¢chement des adresses
    ```
    ```bash
    dhclient #Renouv√®lement
    ```

    :::tip
    Pour une raison que j'ignore, Proxmox n'accepte pas de rel√¢cher l'adresse qui provient de la machine source avant d'obtenir une nouvelle adresse IP.
    :::

    **<span class="yellow-text">Notez bien l'adresse que vous avez obtenu!</span>**

6. √âditez le fichier `/etc/network/interfaces` et modifiez l'IP associ√©e au bridge

    ```yaml title='/etc/network/interfaces' showLineNumbers
    auto lo
    iface lo inet loopback

    iface ens192 inet manual

    auto vmbr0
    iface vmbr0 inet static
            address 172.30.8.214/16     # Cette adresse!!
            gateway 172.30.0.1          # La passerelle au besoin
            bridge-ports ens192
            bridge-stp off
            bridge-fd 0
            
    source /etc/network/interfaces.d/*
    ```
7. √âditez le fichier `/etc/hosts` et modifiez l'ip et le nom d'h√¥te

    ```yaml title='/etc/hosts' showLineNumbers
    127.0.0.1 localhost.localdomain localhost
    172.30.8.214 node02.gabriel.local node02  # Modifiez cette ligne

    # The following lines are desirable for IPv6 capable hosts

    ::1     ip6-localhost ip6-loopback
    fe00::0 ip6-localnet
    ff00::0 ip6-mcastprefix
    ff02::1 ip6-allnodes
    ff02::2 ip6-allrouters
    ff02::3 ip6-allhosts
    ```

8. Supprimez le contenu du dossier `/etc/pve/nodes/template`

    ```bash
    rm -rf /etc/pve/nodes/template
    ```

9. Supprimez le fichier `/etc/machine-id`

    ```bash
    rm -f /etc/machine-id
    ```

10. Supprimez le fichier `/var/lib/dbus/machine-id`

    ```bash
    rm -f /var/lib/dbus/machine-id
    ```

11. G√©n√©rez un nouvel identifiant unique pour le noeud

    ```bash
    dbus-uuidgen --ensure=/etc/machine-id
    ```

12. D√©finissez le nouveau nom de la machine

    ```bash
    hostnamectl set-hostname Node02
    ```

13. Voil√†! Red√©marrez le nouveau noeud et il sera pr√™t √† √™tre utilis√©.

### √âtape 1 : **ZFS** (10 points)

Sur chacun des noeuds:

- Cr√©er un pool **ZFS** (*2 points*)
- Cr√©er les datasets suivants: (*8 points*)

    |Nom|Type|Contenu|
    |---|----|-------|
    |`vm-prod`|ZFS|Disques durs des *VMs* de la production|
    |`vm-dev`|ZFS|Disques durs des *VMs* des d√©veloppeurs|
    |`backups`|Directory|Fichiers de sauvegarde|
    |`templates`|ZFS|Disques durs des *VMs* mod√®les(*templates*)|

**<span class="fonttaller green-text">Livrables</span>**

- Sortie de `zfs list` montrant les datasets cr√©√©s dans chaque noeud.
- Captures d'√©cran de la configuration des storages dans Proxmox.

### √âtape 2 : **Utilisateurs et permissions** (15 points)

Cr√©er les groupes suivants: (3 points)

- `admins-infra`: Administrateurs complets
- `ops-backup`: √âquipe responsable des sauvegardes
- `devs-junior`: D√©veloppeurs avec acc√®s limit√©

Cr√©er les utilisateurs suivants dans le realm PVE: (4 points)

- `admin1@pve` (membre de `admins-infra`)
- `backup-ops@pve` (membre de `ops-backup`)
- `dev1@pve` (membre de `devs-junior`)

Configurer les permissions suivantes: (8 points)

- Le groupe `admins-infra` doit avoir tous les droits sur `/`
- Le groupe `ops-backup` doit pouvoir:
    - Voir toutes les *VMs*
    - G√©rer les sauvegardes (cr√©ation, restauration, suppression)
    - Acc√©der au stockage de backup uniquement
- Le groupe `devs-junior` doit pouvoir, sur le pool `dev-pool` uniquement :
    - D√©marrer/arr√™ter les *VMs*
    - Acc√©der √† la console (l'√©cran des *vms*)
    - **NE PAS** pouvoir supprimer ou cr√©er des *VMs*

**<span class="fonttaller green-text">Livrables</span>**

- Captures d'√©cran de la configuration des permissions.
- Captures d'√©cran des diff√©rents tests d√©montrant un acc√®s ou une interdiction.

### √âtape 3: **Gestion des VMs et des Pools** (20 points)

Cr√©er les pools de ressources suivants (3 points):

- `prod-pool`: *VMs* de production
- `dev-pool`: *VMs* de d√©veloppement
- `backup-pool`: *VMs* de test de restauration

Cr√©er et configurer les *VMs* suivantes (12 points):

|**VM**|**Pool**|**OS**|**vCPU**|**RAM**|**Disque**|**Stockage ZFS**|**Particularit√©s**|
|------|--------|------|--------|-------|----------|----------------|------------------|
|web-prod-01|prod-pool|Ubuntu/Debian|2|2GB|20GB|vm-prod|Doit √™tre HA|