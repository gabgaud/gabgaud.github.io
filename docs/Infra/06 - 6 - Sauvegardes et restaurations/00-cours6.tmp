import useBaseUrl from '@docusaurus/useBaseUrl';
import ThemedImage from '@theme/ThemedImage';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Cours 6

## Sauvegardes et restaurations üíæ

Les sauvegardes constituent un √©l√©ment fondamental de tout d√©ploiement informatique s√©rieux. Dans l'environnement de virtualisation Proxmox VE, la sauvegarde devient encore plus critique car elle prot√®ge non seulement les donn√©es, mais √©galement l'infrastructure virtuelle compl√®te.

<span class="green-text fonttaller">**Pourquoi sauvegarder dans un environnement virtualis√© ?**</span><br/><br/>

- Protection contre les pannes mat√©rielles du serveur h√¥te
- R√©cup√©ration rapide apr√®s une corruption de donn√©es
- Migration vers de nouveaux √©quipements
- Tests et d√©veloppement sur des copies exactes de production
- Conformit√© aux politiques de s√©curit√© informatique

### Caract√©ristiques du syst√®me de sauvegarde Proxmox VE

Proxmox VE offre une solution de sauvegarde compl√®tement int√©gr√©e qui pr√©sente plusieurs avantages distinctifs :

<span class="green-text fonttaller">**Sauvegardes compl√®tes uniquement:**</span><br/><br/>

- Chaque sauvegarde contient l'int√©gralit√© de la machine virtuelle ou du conteneur
- Inclut automatiquement la configuration de la VM/CT et toutes les donn√©es
- Pas de gestion complexe de sauvegardes incr√©mentales ou diff√©rentielles
- Simplicit√© de restauration : une seule archive suffit

<span class="green-text fonttaller">**Int√©gration native:**</span><br/><br/>

- Utilise les capacit√©s sp√©cifiques de chaque type de stockage
- S'adapte aux diff√©rents types de syst√®mes invit√©s (VM et conteneurs)
- Interface graphique et ligne de commande disponibles
- Gestion centralis√©e depuis l'interface web

## Architecture et stockage des sauvegardes

### Types de stockage pour les sauvegardes

Avant de pouvoir effectuer une sauvegarde, il est imp√©ratif de configurer un stockage de sauvegarde. Proxmox VE supporte deux approches principales :

#### Proxmox Backup Server 

Le Proxmox Backup Server repr√©sente la solution la plus avanc√©e :

<span class="green-text">**Avantages techniques:**</span><br/><br/>

- **D√©duplication de donn√©es :** Les blocs identiques ne sont stock√©s qu'une seule fois, √©conomisant consid√©rablement l'espace
- **Stockage des m√©tadonn√©es :** Les informations de structure sont s√©par√©es des donn√©es
- **Chiffrement c√¥t√© client :** S√©curit√© maximale des donn√©es sauvegard√©es
- **V√©rification d'int√©grit√© :** Contr√¥les automatiques de l'int√©grit√© des sauvegardes

<span class="green-text">**Mise en oeuvre recommand√©e:**</span><br/><br/>

- D√©ploiement sur un serveur d√©di√© pour optimiser les performances
- R√©seau haute vitesse entre Proxmox VE et le Backup Server
- Stockage local rapide sur le serveur de sauvegarde

#### Stockage de niveau fichier

Alternative plus simple utilisant des syst√®mes de fichiers classiques :

<span class="green-text">**Options disponibles:**</span><br/><br/>

- **NFS :** Solution r√©seau √©prouv√©e, facile √† mettre en ≈ìuvre
- **SMB/CIFS :** Compatible avec les environnements Windows
- **Stockage local :** Performance maximale mais pas de protection contre les pannes du serveur

<span class="green-text">**Consid√©rations pratiques:**</span><br/><br/>

- Les sauvegardes sont stock√©es comme des fichiers r√©guliers
- Possibilit√© de copie vers bande magn√©tique pour archivage hors site
- Gestion manuelle de l'espace disque n√©cessaire

### Nomenclature des fichiers de sauvegarde

Proxmox VE utilise une convention de nommage standardis√©e qui encode des informations importantes :

<span class="green-text">**Format standard:**</span><br/><br/>

```
vzdump-[type]-[vmid]-[date]-[heure].[extension]
```

<span class="green-text">**Exemple concret:**</span><br/><br/>

```
vzdump-lxc-105-2025_09_08-10_47_09.tar.gz
```

- `lxc`: Type de syst√®me (conteneur Linux)
- `105`: Identifiant num√©rique de la VM/conteneur
- `2025_09_08`: Date de cr√©ation (8 septembre 2025)
- `10_47_09`: Heure de cr√©ation (10:47:09)
- `.tar.gz`: Format et compression utilis√©s

<span class="green-text">**Avantages de cette nomenclature:**</span><br/><br/>
- Stockage multiple dans le m√™me r√©pertoire
- Identification rapide du contenu
- Tri chronologique automatique
- Compatibilit√© avec les scripts d'automatisation

### Modes de sauvegarde - Concepts fondamentaux

Le choix du mode de sauvegarde repr√©sente un compromis entre la coh√©rence des donn√©es et le temps d'arr√™t du service. Proxmox VE propose trois modes principaux, chacun adapt√© √† des besoins sp√©cifiques.

#### Mode STOP (arr√™t) üõë

<span class="green-text fonttaller">**Pour les *VMs*:**</span><br/><br/>

1. Arr√™t propre : La VM re√ßoit un signal d'extinction normale
2. Processus QEMU de sauvegarde : Un processus d√©di√© lit les disques virtuels
3. Red√©marrage : La VM red√©marre automatiquement apr√®s le d√©but de la sauvegarde
4. Sauvegarde en arri√®re-plan : Utilise les capacit√©s de sauvegarde live de QEMU
<br/>

|**Avantages**|**Inconv√©nients**|
|-------------|-----------------|
|**Coh√©rence maximale:** Aucune √©criture pendant la lecture des donn√©es| **Temps d'arr√™t:** Service indisponible pendant l'arr√™t et le red√©marrage|
|**Fiabilit√© absolue:** Pas de risque d'incoh√©rence des donn√©es| **Dur√©e variable:** D√©pend de la taille des donn√©es et de la vitesse du stockage|
|**Simplicit√©:** Processus lin√©aire et pr√©visible||

**Cas d'usage recommand√©s:**
- Serveurs de base de donn√©es critiques
- Sauvegardes de maintenance programm√©es
- Lorsque les donn√©es priment

<span class="green-text fonttaller">**Pour les conteneurs LXC:**</span><br/><br/>

- Arr√™t complet du conteneur pendant toute la dur√©e de la sauvegarde
- Temps d'arr√™t potentiellement tr√®s long selon la taille des donn√©es
- Recommand√© uniquement pour les petits conteneurs ou les maintenances

#### Mode SUSPEND (Suspension) ‚è∏Ô∏è

<span class="green-text fonttaller">**Pour les *VMs*:**</span><br/><br/>

:::important
Ce mode est maintenu pour compatibilit√©, mais le mode snapshot est g√©n√©ralement pr√©f√©rable car il offre une meilleure performance avec une coh√©rence similaire.
:::

<span class="green-text fonttaller">**Pour les conteneurs LXC:**</span><br/><br/>

**Processus en trois √©tapes :**

1. **Premi√®re copie rsync :**
    - Copie des donn√©es vers un r√©pertoire temporaire
    - Le conteneur continue de fonctionner normalement
    - Capture la majorit√© des donn√©es

2. **Suspension et synchronisation :**
    - Arr√™t temporaire du conteneur
    - Deuxi√®me rsync pour capturer les modifications
    - Temps d'arr√™t minimal gr√¢ce √† la pr√©-copie

3. **Reprise et archivage :**
    - Red√©marrage imm√©diat du conteneur
    - Cr√©ation de l'archive finale en arri√®re-plan

|**Avantages**|**Inconv√©nients**|
|-------------|-----------------|
|**Temps d'arr√™t minimal:** Seulement pour la synchronisation finale| **Espace temporaire requis:** Besoin d'un espace suppl√©mentaire pour la copie|
|**Coh√©rence:** Capture un √©tat coh√©rent du syst√®me de fichiers| **Performance r√©seau m√©diocre:** Pour les stockages NFS/CIFS |

#### Mode SNAPSHOT (Instantan√©) üì∏

Le mode snapshot repr√©sente le meilleur compromis pour la plupart des cas d'usage en production. Imaginez que vous photographiez un paysage depuis une voiture en mouvement. Le mode snapshot fait exactement cela : il "photographie" les donn√©es d'une VM pendant qu'elle continue de fonctionner.

<span class="green-text fonttaller">**Pour les *VMs* :**</span><br/><br/>

**Comment √ßa fonctionne concr√®tement:**

**√âtape 1: Installation du surveillant**
- La *VM* fonctionne normalement. 
- QEMU installe un ¬´ intercepteur ¬ª qui surveille tous les disques.
- La *VM* ne remarque rien et continue son travail.

**√âtape 2: Processus de copie intelligent**
- Le processus de sauvegarde d√©marre et commence √† lire le disque
- La VM continue d'√©crire sur le disque en m√™me temps !
- **Solution :** quand la VM veut √©crire sur une zone pas encore copi√©e, l'intercepteur dit "STOP ! Je copie d'abord l'ancienne version"
- Une fois l'ancienne version copi√©e, la VM peut √©crire la nouvelle

**R√¥le de l'agent invit√© (optionnel mais recommand√©):**

L'agent **QEMU** permet d'am√©liorer le processus de sauvegarde en mode *snapshopt* en maintenant une communication avec l'hperviseur. Voici le flux des √©tapes d'une sauvegarde dans ce mode avec l'agent **QEMU** install√©:

1. L'agent re√ßoit le signal: ¬´ Pr√©pare-toi pour une sauvegarde ¬ª.
2. L'agent dit aux applications: ¬´ Videz vos m√©moires caches respectives ¬ª.
3. L'agent g√®le le syst√®me de fichiers (2-3 secondes).
4. La sauvegarde d√©marre avec un √©tat coh√©rent.
5. L'agent d√©g√®le le syst√®me.

:::caution[Avec Windows]
Windows peut avoir plusieurs logiciels qui ¬´ g√®lent ¬ª le syst√®me (antivirus, autres sauvegardes). L'agent QEMU coordonne tout cela pour √©viter les conflits.
:::

<span class="green-text fonttaller">**Pour les conteneurs LXC :**</span><br/><br/>

:::caution
Pour les conteneurs, le mode ¬´ snapshot ¬ª utilise les vraies fonctionnalit√©s de snapshot du syst√®me de stockage. Il s'agit donc d'un v√©ritable *snapshot* et non pas d'une sauvegarde de type *snapshot*. 

Voir [cette section](../05%20-%205%20-%20Administration%20de%20VMs%20avanc√©e/00-cours5.md#diff√©rencier-snapshots-et-backups-) pour bien distinguer les deux concepts sans ambiguit√©.
:::

## Fonctionnalit√©s avanc√©es üõ†Ô∏è

### *VM* Backup Fleecing - Acc√©l√©rateur de sauvegarde

Imaginez que vous voulez sauvegarder une machine virtuelle sans l'arr√™ter