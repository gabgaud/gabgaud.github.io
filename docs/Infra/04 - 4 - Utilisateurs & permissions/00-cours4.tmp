import useBaseUrl from '@docusaurus/useBaseUrl';
import ThemedImage from '@theme/ThemedImage';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Cours 4

## Utilisateurs & permissions üë®‚Äçüë©‚Äçüëß‚Äçüë¶

### Objectifs de ce cours ‚úÖ

√Ä la fin de ce cours, vous serez capable de:

- Comprendre les m√©canismes d'authentification et d'autorisation dans Proxmox VE
- Expliquer la diff√©rence entre utilisateurs, groupes, r√¥les et permissions
- Cr√©er et configurer des utilisateurs avec diff√©rents syst√®mes d'authentification
- Mettre en place une architecture de permissions s√©curis√©e et maintenable
- Impl√©menter l'authentification √† deux facteurs pour renforcer la s√©curit√©
- Automatiser la gestion des utilisateurs via les outils en ligne de commande

### Pourquoi ? ü§î

Dans un environnement de virtualisation comme Proxmox VE (ou VMware), plusieurs personnes peuvent avoir besoin d'acc√©der au syst√®me avec des besoins diff√©rents :

- **Administrateurs de l'hyperviseur:** Acc√®s complet pour la maintenance et la configuration.

- **Administrateurs de VMs:** Gestion des machines virtuelles sans acc√®s aux param√®tres syst√®me.

- **Utilisateurs finaux:** Acc√®s limit√© √† leurs propres *VMs* (d√©marrer/arr√™ter, console)

- **Comptes d'application:** Acc√®s automatis√© via API pour l'int√©gration avec d'autres syst√®mes.

Une gestion granulaire permet de respecter le **principe du moindre privil√®ge** : chaque utilisateur n'a que les permissions strictement n√©cessaires √† ses fonctions.

### Principe RBAC üëç

Tout comme vous l'avez appris dans le cours *Serveurs 3 : Administration Centralis√©e*, Proxmox adopte aussi la m√©thode **RBAC** (*Role Base Access Control*). Cette m√©thodologie de gestion adopte une architecture √† quatre niveaux:

```yaml
Utilisateur --> Groupe --> R√¥le --> Permissions sur les ressources
```

<div style={{textAlign: 'center'}}>
    <ThemedImage
        alt="Sch√©ma"
        sources={{
            light: useBaseUrl('/img/Virtu/RBAC_W.svg'),
            dark: useBaseUrl('/img/Virtu/RBAC_D.svg'),
        }}
    />
</div>

Cette fa√ßon de proc√©der permet une gestion plus granulaire des permissions et √©vite de perdre de vue quels utilisateurs poss√®dent quelles permissions.

### Domaine d'authentification üîë

Un **domaine d'authentification** (ou *realm* en anglais) d√©finit o√π et comment les identifiants des utilisateurs sont stock√©s et v√©rifi√©s. Proxmox permet l'utilisation de plusieurs domaines d'authentification pour se connecter. On distinguera alors l'utilisateur et le domaine d'authentification gr√¢ce au caract√®re `@`.

Exemples:

- `admin@pve` : Utilisateur ¬´ Admin ¬ª dans le domaine d'authentification Proxmox VE interne.
- `john@pam` : Utilisateur ¬´ John ¬ª dans le domaine d'authentification PAM.
- `marie@patate-ldap` : Utilisateur ¬´ Marie ¬ª dans le domaine LDAP de l'entreprise patate.

#### Linux PAM (Pluggable Authentication Modules)

PAM est un syst√®me d'authentification flexible utilis√© par Linux (Ubuntu par exemple) pour v√©rifier l'identit√© des utilisateurs. Quand vous vous connectez √† un syst√®me Linux avec votre nom d'utilisateur et mot de passe, c'est PAM qui v√©rifie vos informations.

**Comment √ßa fonctionne:**

1. L'utilisateur entre ses informations de connexion.
2. Proxmox VE interroge PAM pour v√©rifier le mot de passe.
3. PAM consulte les fichiers syst√®me `/etc/passwd` et `/etc/shadow`.

**Avantages:**

- Simple √† configurer pour de petites installations.
- Utilise l'infrastructure existante du syst√®me.
- S√©curit√© √©prouv√©e de Linux

**Inconv√©nients:**

- L'utilisateur doit exister sur **chaque n≈ìud** du cluster (pas pratique!)
- Gestion manuelle des utilisateurs sur chaque serveur
- Pas de gestion centralis√©e des mots de passe.

#### Serveur d'authentification Proxmox VE

Syst√®me de gestion des mots de passe int√©gr√© directement dans Proxmox VE.

**Comment √ßa fonctionne:**

1. Les informations utilisateur sont stock√©es dans `/etc/pve/user.cfg`.
2. Les mots de passe sont hach√©s (SHA-256) et stock√©s dans `/etc/pve/priv/shadow.cfg`.
3. Ces fichiers sont automatiquement synchronis√©s entre tous les n≈ìuds du cluster (Un gros avantage!).
4. Les utilisateurs peuvent changer leur mot de passe via l'interface web.

**Avantages:**

- Gestion centralis√©e (un seul endroit pour tous les utilisateurs).
- Synchronisation automatique dans le cluster.
- Interface web conviviale pour les utilisateurs.
- Parfait pour les installations de petite √† moyenne envergure.

**Inconv√©nients:**

- Limit√© √† Proxmox VE (pas d'int√©gration avec d'autres syst√®mes)
- Gestion manuelle des utilisateurs.

**Cas d'usage typique:** Une entreprise avec 10-50 utilisateurs qui n'ont besoin d'acc√©der qu'√† Proxmox VE.

#### LDAP (Lightweight Directory Access Protocol)

Comme vous l'avez √©tudi√© dans le cours **Serveurs 3: Administration Centralis√©e**, LDAP est un protocole standard pour acc√©der √† des annuaires d'entreprise, tel que *Active Directory* par exemple. Ce type d'annuaire est particuli√®rement int√©ressant et utilis√© dans de grandes entreprises. Il permet de centraliser la gestion des comptes et de l'authentification.

En entreprise, il est plut√¥t rare (mais pas impossible...) que vous arriviez nez √† nez avec un serveur OpenLDAP √©tant donn√© la domination de Microsoft avec *Active Directory* dans cette sph√®re.

#### Microsoft Active Directory

Je crois que je n'ai plus besoin de vous le pr√©senter üòâ... Tel que mentionn√© ci-dessus, *Active Directory* est un ensemble de services (dont LDAP) permettant de centraliser et de s√©curiser les diff√©rents comptes d'utilisateur d'une entreprise. *Active Directory* poss√®de plus de fonctionnalit√©s que le simple protocole LDAP.

Le principal avantage d'*AD*, c'est qu'il est g√©n√©ralement d√©j√† implant√© dans la plupart des entreprises. En l'int√©grant √† Proxmox, les utilisateurs pourraient conserver leur nom d'utilisateur ainsi que leur mot de passe pour ouvrir une session sur Proxmox. C'est un avantage assez consid√©rable.

#### OpenID Connect

OpenID Connect est un protocole moderne d'authentification qui permet **l'authentification unique** (Single Sign-On ou SSO). Ce principe vous permet d'utiliser l'authentification d'un site tiers pour vous connecter √† Proxmox.

**Comment √ßa fonctionne:**

1. L'utilisateur clique sur ¬´ Se connecter avec Google ¬ª dans Proxmox VE.
2. Il est redirig√© vers Google pour s'authentifier
3. Google confirme ou infirme l'identit√© √† Proxmox VE.
4. L'utilisateur se voit autoris√© ou refus√© dans le syst√®me.