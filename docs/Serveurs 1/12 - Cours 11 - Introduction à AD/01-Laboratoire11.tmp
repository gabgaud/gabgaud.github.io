import useBaseUrl from '@docusaurus/useBaseUrl';
import ThemedImage from '@theme/ThemedImage';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Laboratoire 11
* * *

## Installation et configuration d'un domaine Active Directory

## PrÃ©alable(s)

- Avoir complÃ©tÃ© le laboratoire # 10

:::caution
Vous pouvez supprimer les machines virtuelles crÃ©Ã©es jusqu'Ã  maintenant. Ã€ l'exception de votre passerelle, nous ne rÃ©utiliserons pas les machines prÃ©cÃ©dentes.
:::

## Objectif(s)
- DÃ©ployer un premier contrÃ´leur de domaine Active Directory

* * *
## SchÃ©ma

<div style={{textAlign: 'center'}}>
    <ThemedImage
        alt="SchÃ©ma"
        sources={{
            light: useBaseUrl('/img/Serveurs1/Laboratoire11_W.svg'),
            dark: useBaseUrl('/img/Serveurs1/Laboratoire11_D.svg'),
        }}
    />
</div>

* * *

## Ã‰tapes de rÃ©alisation

### Initialisation d'un nouveau serveur

Vous aurez besoin d'un serveur sous Windows pour crÃ©er votre premier contrÃ´leur de domaine. <mark>**N'installez pas Windows Serveur depuis zÃ©ro.**</mark> Utilisez plutÃ´t le modÃ¨le disponible sur LabInfo pour crÃ©er votre nouveau serveur Windows.

![Modele](../Assets/11/Modele_Win2022.png)

Une fois que votre machine sera fonctionnelle, assurez-vous de complÃ©ter quelques Ã©tapes initiales avant d'installer quoi que ce soit:

1. Attribuez une adresse IP statique Ã  votre serveur (Ex: 192.168.21.10) 

    :::caution
    L'adresse du serveur DNS doit Ãªtre 127.0.0.1. Pour rappel, il s'agit d'une adresse IP de type alias qui signifier Â« moi-mÃªme Â». Notre serveur Windows sera donc, lui-mÃªme, son propre serveur DNS.
    :::
2. Renommez votre serveur avec un nom plus convivial (Ex: dc1)

### Installation du rÃ´le ADDS

- Dans votre gestionnaire de serveur, cliquez sur Â« Ajouter des rÃ´les et des fonctionnalitÃ©s Â».

    ![RoleFonctionnalites](../Assets/11/AjouterRoleFonctionnalites.png)

- Vous pouvez ignorer la page Â« Avant de commencer Â».

    ![AvantDeCommencer](../Assets/11/AvantDeCommencer.png)

- SÃ©lectionnez Â« Installation basÃ©e sur un rÃ´le ou une fonctionnalitÃ© Â»

    ![RoleBased](../Assets/11/RoleBased.png)

- Le serveur de destination ne peut Ãªtre que le seul que vous avez installÃ©. SÃ©lectionnez-le et cliquez sur suivant

    ![ServeurDest](../Assets/11/ServeurDest.png)

- Dans la liste des rÃ´les disponibles, sÃ©lectionnez les services ADDS et cliquez sur Â« suivant Â»

    ![ServicesADDS](../Assets/11/ServicesADDS.png)

- Dans la liste des fonctionnalitÃ©s, vous n'avez rien Ã  cocher. Contentez vous de cliquer sur Â« suivant Â»

- Cliquez sur suivant Ã  la page vous expliquant les services Active Directory, puis cliquez sur Â« Installer Â».

- Une fois l'installation terminÃ©e, cliquez sur Â« Fermer Â».

### Promotion du serveur en contrÃ´leur de domaine

Installer le rÃ´le ADDS (*Active Directory Domain Services*) ne transforme pas, systÃ©matiquement, notre serveur en contrÃ´leur de domaine. En effet, la mise en place d'un domaine racine ainsi l'initialisation du premier contrÃ´leur de domaine est une Ã©tape que l'on nomme : La promotion vers le rÃ´le de contrÃ´leur de domaine.

Suite Ã  l'installation du rÃ´le, vous remarquerez sans doute un point d'exclamation jaune prÃ¨s du menu Â« Outils Â». Cliquez sur celui-ci afin de pouvoir entreprendre la promotion du serveur.

![dcpromo](../Assets/11/DCPromo.png)

#### Configuration du dÃ©ploiement

Vous aurez **3** possibilitÃ©s de dÃ©ploiement:

**Ajouter un contrÃ´leur de domaine Ã  un domaine existant**<br/>
Cette option vous permet de dÃ©ployer un contrÃ´leur supplÃ©mentaire dans une infrastructure AD dÃ©jÃ  existante. Ce qui n'est pas notre cas ici.

**Ajouter un nouveau domaine Ã  une forÃªt existante**<br/> 
Comme elle le mentionne bien, cette option permet d'ajouter un domaine supplÃ©mentaire. Cela dit, il nous faudrait dÃ©jÃ  une forÃªt, ce que nous n'avons pas ici.

**Ajouter une nouvelle forÃªt**<br/>
Il s'agit de l'option Ã  utiliser lorsque nous n'avons rien en place et que l'on dÃ©marre depuis zÃ©ro. C'est notre ca. Choisissez cette option.


![NouvelleForet](../Assets/11/NewForest.png)

:::danger
Le nom d'un domaine, et c'est encore plus vrai dans le cas du domaine racine, est Ã  peu prÃ¨s **inchangeable.** Vous ne pouvez donc pas vous permettre une erreur ici, sans quoi, vous devrez rÃ©installer toute la strucuture de l'AD. Choisissez donc consciensieusemment votre nom de domaine.
:::

#### Options du contrÃ´leur de domaine

##### Les niveaux fonctionnels

Les niveaux fonctionnels (forÃªt et domaine racine), permettent d'adapter le fonctionnement de votre infrastructure en fonction de possibles autres contrÃ´leurs de domaine que vous pourriez avoir sur votre rÃ©seau. Cela permet, par exemple, de faire fonctionner un contrÃ´leur de domaine sous Windows Serveur 2008 avec un contrÃ´leur de domaine sous Windows 2022 sans problÃ¨me.

Or, nous n'avons aucune infrastructure pour le moment et tout reste Ã  construire. Vous pouvez donc laisser les niveaux fonctionnels ainsi.

##### Les fonctionnalitÃ©s de contrÃ´leur de domaine

Il vous faudra spÃ©cifier les fonctionnalitÃ©s du contrÃ´leur de domaine que vous voulez mette en place:

**Serveur DNS:**<br/>
Il s'agit d'une fonctionnalitÃ© obligatoire pour Ãªtre en mesure d'utiliser Active Directory. Comme nous ne l'avons pas installÃ© jusqu'Ã  prÃ©sent, nous n'avons guÃ¨re le choix que de l'installer dÃ¨s maintenant avec AD.

**Catalogue global (GC):**<br/>
Le catalogue global contient toutes les dÃ©finitions d'objets ainsi que leurs attributs respectifs. Il est essentiel au fonctionnement de l'Active Directory. Il doit y avoir au moins un catalogue global dans une forÃªt. Vous l'aurez donc compris, nous devons laisser cette option cochÃ©e puisqu'Ã  l'heure actuelle, nous n'avons aucune infrastructure.

**ContrÃ´leur de domaine en lecture seule (RODC):**<br/>
Ce type de contrÃ´leur de domaine est utilisÃ© dans des cas bien particuliers. Vous aurez l'occasion de le mettre en place dans le cadre du cours Serveurs 3. Pour l'instant, cette fonctionnalitÃ© ne nous intÃ©resse pas.

##### Mot de passe DSRM

Le mode de restauration des services d'annuaire est un mode spÃ©cial qui permet de restaurer ou de rÃ©parer une base de donnÃ©es Active Directory en cas de corruption ou de problÃ¨me majeur. DÃ©finir un mot de passe permet de sÃ©curiser ce mode et d'empÃªcher une restauration involontaire ou malveillante.

![DCOptions](../Assets/11/DCOptions.png)

#### Options DNS

Les options DNS permettent de crÃ©er une dÃ©lÃ©gation DNS. Ce type de dÃ©lÃ©gation permet de dÃ©lÃ©guer le contrÃ´le d'un sous-domaine Ã  un serveur DNS prÃ©cis. Or dans notre cas, nous n'avons pas de zone parente encore. Il est donc impossible de dÃ©lÃ©guer quoi que ce soit, cliquez simplement sur Â« suivant Â»:

![DnsOptions](../Assets/11/DnsOPtions.png)

#### Options supplÃ©mentaires

Le nom de domaine NETBIOS est configurÃ© pour assurer une rÃ©trocompatibilitÃ© avec de vieux systÃ¨mes. Il n'est que trÃ¨s peu utilisÃ©. Je vous recommande de laisser la configuration par dÃ©faut, qui correspond normalement Ã  votre nom de domaine, en majuscules, sans suffixe.

![Netbios](../Assets/11/NetBIOSName.png)

#### Chemin d'accÃ¨s

Les chemins d'accÃ¨s de la base de donnÃ©es, des fichiers journaux et du dossier SYSVOL ne devraient jamais Ãªtre modifiÃ©s Ã  moins de configurations ou de circonstances exceptionnelles. Laissez-les donc tels quels pour le moment.

![CheminAcces](../Assets/11/CheminAcces.png)

#### Examiner les options & VÃ©rifications

Les deux derniÃ¨res Ã©tapes consistent Ã  repasser vos propres configurations et Ã  procÃ©der Ã  une validation de celles-ci. Lors de la vÃ©rification, il n'est pas rare de voir quelques avertissement apparaitre. Les deux avertissements les plus frÃ©quents sont les suivants:

:::caution[1er avertissement]
<br/>
![ChiffrementFaible](../Assets/11/AvertiisementChiffrement.png)

Cet avertissement nous fait savoir que le contrÃ´leur de domaine de Windows Server 2022 prend des mesures pour empÃªcher l'utilisation de mÃ©thodes de chiffrement faibles tout en permettant une compatibilitÃ© avec les anciennes versions de Windows. Cela renforce la sÃ©curitÃ© tout en prÃ©servant l'interopÃ©rabilitÃ© avec des systÃ¨mes plus anciens. C'est une information intÃ©ressante plus qu'un rÃ©el avertissement.
:::

:::caution[2Ã¨me avertissement]
<br/>
![AvertissementDelegationDNS](../Assets/11/AvertissementDelegationDNS.png)

Cet avertissement nous avise qu'il est impossible de crÃ©er une dÃ©lÃ©gation DNS (oui, encore!) car la zone parente est inexistante ou introuvable. C'est tout Ã  fait normal dans notre cas puisque le serveur DNS n'est pas encore installÃ© ni configurÃ©. Attardez vous donc Ã  la fin du message : Sinon, aucune action n'est requise. ğŸ˜‰
:::

#### Installation

VoilÃ , il ne nous reste qu'Ã  cliquer sur Â« Installer Â». Les services ADDS sont assez lourds. L'installation engendrera un redÃ©marrage du serveur et cela peut vous demander de patienter un peu.

![InstallPromoAD](../Assets/11/InstallPromoAD.png)

### PremiÃ¨re ouverture de session

Lorsque le serveur aura terminÃ© son redÃ©marrage, il sera officiellement devenu un contrÃ´leur de domaine Active Directory. Vous ouvrirez alors votre session non pas en tant qu'administrateur du serveur mais en tant qu'administrateur du domaine. Les administrateurs du domaine ont non seulement des privilÃ¨ges d'administration sur les contrÃ´leurs du domaine mais Ã©galement sur tous les postes qui sont reliÃ©s au domaine.

Appuyez donc sur les touches <kbd>Ctrl</kbd>+<kbd>Alt</kbd>+<kbd>Del</kbd> pour faire apparaitre l'Ã©cran d'ouverture de session et vous identifier:

![OuvertureSession](../Assets/11/OuvertureSession.png)

### CrÃ©ation d'objets
Ouvrez le menu `Outils` du gestionnaire de serveur et cliquez sur `Utilisateurs et ordinateurs Active Directory`. Vous vous retrouverez dans une console similaire Ã  celle-ci:

![ConsoleADUsers](../Assets/11/ConsoleADUsers.png)

C'est dans cette console que nous crÃ©erons nos utilisateurs, nos groupes ainsi que nos unitÃ©s d'organisation. 

#### CrÃ©ation d'unitÃ©s d'organisation

Pour crÃ©er un nouvel objet dans la structure, il vous suffit d'utiliser le bouton de droite de la souris. Par exemple, pour crÃ©er une unitÃ© d'organisation nommÃ© Â« patate Â» Ã  la racine du domaine, je ferai un clic Ã  l'aide du bouton de droite de la souris sur la racine de mon domaine:

![ObjCreation](../Assets/11/CreerObj.png)

#### CrÃ©ation des utilisateurs

Les utilisateurs sont des objets relativement complexes car ils comportent un lot d'attributs importants. Pour crÃ©er un utilisateur, faites un clic Ã  l'aide du bouton de droite de la souris sur l'unitÃ© d'organisation oÃ¹ vous dÃ©sirez crÃ©er celui-ci. SÃ©lectionnez Â« Nouveau Â», puis Â« Utilisateur Â». Vous vous retrouverez avec une fenÃªtre comportant plusieurs champs Ã  remplir:

![CreationUtilisateur](../Assets/11/CreationUtilisateur.png)

![CreationUtilisateur2](../Assets/11/UserPass.png)

Une fois le mot de passe entrÃ©, vous pourrez confirmer la crÃ©ation de l'utilisateur et l'opÃ©ration sera terminÃ©e.

#### CrÃ©ation des groupes

Les groupes sont plutÃ´t rapides Ã  crÃ©erÂ­. Lorsque vous crÃ©ez un nouveau groupe, il ne suffit que de lui octroyer un nom pour procÃ©der Ã  sa crÃ©ation. Cela dit, vous remarquerez Ã©galement deux Ã©lÃ©ments Ã  configurer: L'Ã©tendue et le type de groupe.
|Ã‰lÃ©ment|Description|
|:------:|-------------------|
| **Ã‰tendue** | L'Ã©tendue d'un groupe dÃ©termine sa portÃ©e. L'Ã©tendue spÃ©cifie oÃ¹ peut Ãªtre utilisÃ© un groupe. Vous aurez l'occasion d'explorer ces concepts en profondeur dans le cours Serveurs 3. Dans le cadre de ce cours, vous pouvez utiliser des groupes globaux sans problÃ¨me. |
| **Type** | Le type de groupe spÃ©cifie ce que nous avons l'intention de faire avec ce groupe. Le groupe de sÃ©curitÃ© permet de donner des permissions ou des privilÃ¨ges aux utilisateurs membre du groupe tandis que le groupe de type distribution est surtout utilisÃ© dans le cadre d'envoi de messages Ã©lectroniques Ã  l'aide d'un serveur exchange par exemple. |

![CreationGroupesAD](../Assets/11/CreationGroupes.png)

#### CrÃ©ation des ordinateurs

Les ordinateurs diffÃ¨rent des autres objets dans Active Directory. <mark>**Vous ne devez pas les crÃ©er manuellement.**</mark> Pour intÃ©grer un ordinateur dans la strucutre des objets de l'AD, nous devons joindre ce dernier au domaine. Nous verrons un peu plus loin comment procÃ©der pour effectuer cette action.

- - - 

Maintenant que nous avons vu ensemble comment crÃ©er les objets les plus communs dans Active Directory, crÃ©ez la structure d'unitÃ©s d'organisation, d'utilisateurs et de groupes suivante:

<div style={{textAlign: 'center'}}>
    <ThemedImage
        alt="SchÃ©ma"
        sources={{
            light: useBaseUrl('/img/Serveurs1/AD_Users_W.svg'),
            dark: useBaseUrl('/img/Serveurs1/AD_Users_D.svg'),
        }}
    />
</div>



