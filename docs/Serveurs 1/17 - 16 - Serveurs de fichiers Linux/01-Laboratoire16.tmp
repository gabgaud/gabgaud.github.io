import useBaseUrl from '@docusaurus/useBaseUrl';
import ThemedImage from '@theme/ThemedImage';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Laboratoire 16
* * *

## Ajout d'un serveur de fichiers (linux) à votre infrastructure

## Préalable(s)

- Avoir complété le laboratoire # 15 (nous réutilisons les VM)

## Objectif(s)

- Ajouter un serveur de fichier linux afin de centraliser les données

* * *
## Schéma

<div style={{textAlign: 'center'}}>
    <ThemedImage
        alt="Schéma"
        sources={{
            light: useBaseUrl('/img/Serveurs1/Laboratoire16_W.svg'),
            dark: useBaseUrl('/img/Serveurs1/Laboratoire16_D.svg'),
        }}
    />
</div>

* * *

## Étapes de réalisation

Pour ce laboratoire, je prendrai pour acquis que vous avez importé votre nouveau serveur Linux, que vous lui avez octroyé un nom pertinent et que vous avez bien configuré son adresse IP statique.

## Création d'utilisateurs et de dossiers

Avant de partager des dossiers à la volée, il nous faut d'abord deux éléments:

1. Des utilisateurs et des groupes à qui donner des accès
2. Des dossiers sur lesquels nous gérerons les permissions de partage.

### Utilisateurs & groupes

Créer donc les utilisateurs et les groupes suivants sur votre serveur de fichiers (*Rappel: Commandes `adduser` ,`addgroup` & `usermod`*) :

|Utilisateur|Membre de|
|-----------|---------|
|Bob|Techniciens|
|Paul|Techniciens|
|Rita|RH|
|Claude|Direction|

### Création des dossiers

Créer les dossiers suivants:

|Nom du dossier|Emplacement|Propriétaire|Groupe-Propriétaire|
|---------|--------|----------|----------|
|Bob|/Labo16/Utilisateurs|Bob|Direction|
|Paul|/Labo16/Utilisateurs|Paul|Direction|
|Techniciens|/Labo16/Groupes|Claude|Techniciens|
|Rita|/Labo16/Utilisateurs|Rita|Direction|
|RH|/Labo16/Groupes|Claude|RH|
|Claude|/Labo16/Utilisateurs|Claude|Root|

:::caution[Permissions locales]
Attention de bien régler les permissions locales sur vos dosssiers:

**Dossier des utilisateurs :** Tous les droits à l'utilisateur concerné et Claude. Rien aux autres.<br/>
**Dossier des groupes :** Tous les droits à Claude, lecture & exécution au groupe concerné. Rien aux autres.
:::

## Installation de Samba

Samba est une suite de logiciels qui comprend plusieurs éléments, dont le protocole *SMB* permettant le partage de fichiers et de dossiers avec Windows. Vous avez eu l'occasion d'expérimenter Samba dans le cours de système d'exploitation 1. Or, nous irons un peu plus loin dans le cadre de ce cours. Commencez donc par installer Samba:

```bash
sudo apt install samba -y
```
### Configurations du service

Le fichier de configuration par défaut de Samba est énorme! Néanmoins, il nous faut y apporter quelques modifications. Ouvrez le fichier modifiez **les lignes 39 et 46** comme suit:

```yaml title='/etc/samba/smb.conf'
#### Networking ####

# The specific set of interfaces / networks to bind to
# This can be either the interface name or an IP address/netmask;
# interface names are normally preferred
#highlight-next-line
   interfaces = ens192


# Only bind to the named interfaces and/or networks; you must use the
# 'interfaces' option above to use this.
# It is recommended that you enable this feature if your Samba machine is
# not protected by a firewall or is a firewall itself.  However, this
# option cannot handle dynamic or non-broadcast interfaces correctly.
#highlight-next-line
   bind interfaces only = yes
```

### Configuration des partages

Dirigez-vous à la toute fin du fichier `/etc/samba/smb.conf`. Vous devrez ajouter un paragraphe comme celui qui vous est présenté ci-dessous pour chacun des dossiers que vous avez créé:

```yaml title='/etc/samba/smb.conf'
[Bob]
    comment = Partage du dossier de Bob
    path = /Labo16/Utilisateurs/Bob
    browseable = yes
    guest ok = no
    valid users = bob,@direction
    read only = no
    writable = yes
    create mask = 0750
    force create mask = 0750
    security mask = 0750
    force security mode = 0750
```


